define(["jquery","qtype_vplquestion/codeeditors","qtype_vplquestion/vplservice","qtype_vplquestion/scriptsloader"],function(a,b,c,d){function e(a){switch(a){case"console":return"[Process";case"connected":case"connecting":case"running":return"running]";case"connection_closed":return"exited]";default:return a}}function f(a,b,c){if(a[b]){var d="";return(e=a[b],f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},e.replace(/[&<>"']/g,function(a){return f[a]})).split("\n").forEach(function(a){d+=("-"==a.charAt(0)?'<span class="vpl-test-title">'+a+"</span>":a)+"\n"}),'<div class="vpl-result-title vpl-title-'+c+'">'+M.util.get_string(b,"qtype_vplquestion")+"</div>"+d.trim()}var e,f;return""}function g(b,c){var d=a("#"+b);null===c&&(c=d.data("result"));var e=f(c,"compilation","error")+f(c,"evaluation","info")+f(c,"execerror","error")+f(c,"evaluationerror","error");e||(e=f(c,"execution","error")),d[e?"show":"hide"](),d.html(e)}function h(a){var b=null,c=a.remove().val();if(void 0!=c)for(var d in b=[],c=JSON.parse(c))b.push({name:d,contents:c[d],encoding:0});return b}return{setup:function(f,i,j,k,l){var m=a('textarea[name="'+l+'"]'),n=m.data("template");m.removeAttr("data-template");var o=h(a('input[name="execfiles_q'+f+'"]')),p=h(a('input[name="execfiles_run_q'+f+'"]')),q=1;n.split("\n").forEach(function(a,b){-1!=a.indexOf("{{ANSWER}}")&&(q=b+1)});var r=a("#qvpl_reset_q"+f+", #qvpl_correction_q"+f);b.setupQuestionEditor(k,m,r,q,function(){"readonly"!=m.attr("readonly")&&d.loadVPLTerminal(function(){var b=Terminal.prototype;Terminal=function(a){return a.rows=10,new b.constructor(a)},Terminal.prototype=b;var d="terminal_wrapper_q"+f,h=new VPL_Terminal(d,d,e);h.setMessage=function(){};var k="#qvpl_buttons_q"+f,l="[aria-describedby="+d+"]";a(l).insertAfter(k);var q=h.connect;h.connect=function(){q.apply(h,arguments),a(l).css("top",0).css("left",0),a("body > .ui-widget-overlay.ui-front").first().remove()},a(l+" .ui-dialog-titlebar-close").html('<i class="fa fa-close"></i>').addClass("btn btn-secondary close-terminal");var r=function(b,d,e){var l=a(k+" .qvpl-"+b),o=a('<i class="fa fa-'+d+'"></i>').appendTo(l),p=function(){o.attr("class","fa fa-"+d),a(".qvpl-buttons *").removeAttr("disabled")};l.click(function(){a(".qvpl-buttons *").attr("disabled","disabled"),a(".close-terminal").trigger("click"),o.attr("class","fa fa-refresh fa-spin"),c.call("save",i,j,n,m.val(),e).then(function(){return c.call("exec",b,i,j,h,function(a){g("vpl_result_q"+f,a),p()})}).then(null,function(a){g("vpl_result_q"+f,{execerror:a}),p()})})};r("run","rocket",p),r("debug","check-square-o",o),r("evaluate","check-square-o",o)})})},displayResult:g}});